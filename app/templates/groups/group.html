{% extends "base.html" %}

{% block header %}
<div>

    <h1>{{ group.name }}</h1>
    <div>
        {% for member in members %}
        <span>{{ member.username }},</span>
        {% endfor %}
    </div>
</div>
{% if is_user_group_creator %}
<a href="{{ url_for('groups.edit', group_id=group.id) }}">Edit</a>
{% endif %}
{% endblock %}

{% block content %}
{% if has_more_messages %}
<a href="{{ url_for('groups.group', group_id=group.id, pages=pages + 1) }}">Get more messages</a>
{% endif %}
<div id="chat-messages" style="display: flex; max-height: 62vh; overflow-y: auto; flex-direction: column-reverse; gap: 10px;">
</div>
<input autofocus type="text" name="content" placeholder="Message" onkeydown="handleKeyDown(event)">
<button onclick="handleSendMessage(event)">Send</button>
<script type="text/javascript">
    const chatMessages = {{messages|tojson}};
    const chatMessageFeed = document.getElementById('chat-messages');
    
    const renderChatMessages = function() {
        chatMessageFeed.innerHTML = '';
        chatMessages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.style.border = '1px solid black';
            messageElement.innerHTML = `
            <p>${message.content}</p>
            <span>${message.created_at}</span>
            <span>${message.username}</span>`;
            chatMessageFeed.appendChild(messageElement);
        });
    }
    renderChatMessages();
    var socket = io();

    function markAsDisconnected() {
        const sendButton = document.querySelector('button');
        sendButton.innerHTML = 'Reconnecting...';
        sendButton.disabled = true;
    }

    function markAsConnected() {
        const sendButton = document.querySelector('button');
        sendButton.innerHTML = 'Send';
        sendButton.disabled = false;
    }

    function connectWithRetries(retry = 0) {
        if (retry > 5) {
            return;
        }
        try {
            setTimeout(function() {
                console.debug("Connecting to socket, attempt", retry);
                socket.connect();
            }, 1000 * (retry ** 2));
        } catch (error) {
            console.debug("Failed to connect to socket, retrying...", error);
            connectWithRetries(retry + 1);
        }
    }
    socket.emit('join_group', {group_id: '{{group.id}}'});
    socket.on('connect', function() {
        socket.emit('connected', {data: '{{session.user_id}}'});
    });
    socket.on('message', function(data) {
        console.log('received message', data);
        chatMessages.unshift(data);
        renderChatMessages();
    });

    socket.on('disconnect', function() {
        console.log('disconnected');
        markAsDisconnected();
        connectWithRetries();
    });

    socket.on('connect', function() {
        console.log('connected');
        markAsConnected();
    });
    

    const handleKeyDown = function(event) {
        if (event.key === 'Enter') {
            handleSendMessage(event);
        }
    }

    const handleSendMessage = function(event) {
        event.preventDefault();
        const message = {
            content: document.querySelector('input[name="content"]').value,
            group_id: '{{group.id}}'
        };
        document.querySelector('input[name="content"]').value = '';
        console.log(message);
        socket.send(message);
    };
</script>
{% endblock %}